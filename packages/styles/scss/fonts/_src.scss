//
// Copyright IBM Corp. 2018, 2023
//
// This source code is licensed under the Apache-2.0 license found in the
// LICENSE file in the root directory of this source tree.
//

@use '../config';
@use 'sass:list';
@use 'sass:map';
@use 'sass:meta';

$-filenames: (
  ibm-plex-mono: 'IBMPlexMono',
  ibm-plex-sans-arabic: 'IBMPlexSansArabic',
  ibm-plex-sans-devanagari: 'IBMPlexSansDevanagari',
  ibm-plex-sans-hebrew: 'IBMPlexSansHebrew',
  ibm-plex-sans-thai-looped: 'IBMPlexSansThaiLooped',
  ibm-plex-sans-thai: 'IBMPlexSansThai',
  ibm-plex-sans: 'IBMPlexSans',
  ibm-plex-serif: 'IBMPlexSerif',
);

$-akamai-filenames: (
  ibm-plex-mono: (
    name: 'IBM-Plex-Mono',
    filename: 'IBMPlexMono',
  ),
  ibm-plex-sans-arabic: (
    name: 'IBM-Plex-Sans-Arabic',
    filename: 'IBMPlexSansArabic',
  ),
  ibm-plex-sans-devanagari: (
    name: 'IBM-Plex-Sans-Devanagari',
    filename: 'IBMPlexSansDevanagari',
  ),
  ibm-plex-sans-hebrew: (
    name: 'IBM-Plex-Sans-Hebrew',
    filename: 'IBMPlexSansHebrew',
  ),
  ibm-plex-sans-thai-looped: (
    name: 'IBM-Plex-Sans-Thai-Looped',
    filename: 'IBMPlexSansThaiLooped',
  ),
  ibm-plex-sans-thai: (
    name: 'IBM-Plex-Sans-Thai',
    filename: 'IBMPlexSansThai',
  ),
  ibm-plex-sans: (
    name: 'IBM-Plex-Sans',
    filename: 'IBMPlexSans',
  ),
  ibm-plex-serif: (
    name: 'IBM-Plex-Serif',
    filename: 'IBMPlexSerif',
  ),
);

@function -get-akamai-filename($map, $keys...) {
  @each $key in $keys {
    $map: map.get($map, $key);
  }

  @return $map;
}

@function -get-base-filename($name) {
  @return map.get($-filenames, $name);
}

/// The default resolver for locating a font file in the `@ibm/plex` package.
/// This function will return a path that will work in bundling tools like
/// webpack but will not work without a tool that understands paths that are
/// prefixed with `~`
///
/// @param {String} $name
/// @param {String} $weight
/// @param {String} $style
/// @param {String} $unicode-range
/// @param {List} $formats
/// @returns List
@function -default-resolver($name, $weight, $style, $unicode-range, $formats) {
  @if (config.$use-akamai-cdn) {
    $name: -get-akamai-filename($-akamai-filenames, $name, 'name');
    $filename: -get-akamai-filename($-akamai-filenames, $name, 'filename');

    // Special case for weight = Regular (400)
    @if $weight == Regular {
      @if $style == italic {
        $filename: '#{$filename}-Italic';
      } @else {
        $filename: '#{$filename}-Regular';
      }
    } @else {
      // Otherwise add weight + optional style (italic)
      $filename: '#{$filename}-#{$weight}';

      @if $style == italic {
        $filename: '#{$filename}Italic';
      }
    }

    $filenames: ();

    @each $format in $formats {
      $url: 'https://1.www.s81c.com/common/carbon/plex/fonts/#{$name}';

      @if $unicode-range {
        $url: 'https://1.www.s81c.com/common/carbon/plex/fonts/#{$name}/fonts/split/#{$format}/#{$filename}-#{$unicode-range}';
      } @else {
        $url: 'https://1.www.s81c.com/common/carbon/plex/fonts/#{$name}/fonts/complete/#{$format}/#{$filename}';
      }

      // Add extension
      $url: '#{$url}.#{$format}';
      $filenames: list.append(
        $filenames,
        url('#{$url}') format('#{$format}'),
        $separator: comma
      );
    }

    @return $filenames;
  } @else {
    $filename: -get-base-filename($name);

    // Special case for weight = Regular (400)
    @if $weight == Regular {
      @if $style == italic {
        $filename: '#{$filename}-Italic';
      } @else {
        $filename: '#{$filename}-Regular';
      }
    } @else {
      // Otherwise add weight + optional style (italic)
      $filename: '#{$filename}-#{$weight}';

      @if $style == italic {
        $filename: '#{$filename}Italic';
      }
    }

    $filenames: ();

    @each $format in $formats {
      $url: $filename;

      @if $unicode-range {
        $url: '#{config.$font-path}/#{$name}/fonts/split/#{$format}/#{$filename}-#{$unicode-range}';
      } @else {
        $url: '#{config.$font-path}/#{$name}/fonts/complete/#{$format}/#{$filename}';
      }

      // Add extension
      $url: '#{$url}.#{$format}';
      $filenames: list.append(
        $filenames,
        url('#{$url}') format('#{$format}'),
        $separator: comma
      );
    }

    @return $filenames;
  }
}

/// The resolver used for locating the filepaths in `url() format()` values in
/// @font-face blocks
$resolver: meta.get-function('-default-resolver') !default;

/// Retrieve the list of `url() format()` values used in the `src` property in
/// an `@font-face` block

/// @param {String} $name
/// @param {String} $weight
/// @param {String} $style
/// @param {String} $unicode-range
/// @param {List} $formats
/// @returns List
@function get($name, $weight, $style, $unicode-range: null, $formats) {
  @return meta.call(
    $resolver,
    $name: $name,
    $weight: $weight,
    $style: $style,
    $unicode-range: $unicode-range,
    $formats: $formats
  );
}
