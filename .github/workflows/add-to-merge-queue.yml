name: Merge Queue
on:
  pull_request_target:
    types: [labeled, opened, reopened]

permissions:
  pull-requests: write
  contents: write

jobs:
  add-to-merge-queue:
    name: Add to queue when automerge labels are present
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@f04aa94d10cf56334d1c580e077ce2e3569e805d #1.6.3
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
      - name: Log github event
        env:
          $GITHUB_CONTEXT_LABELS:
            ${{ toJson(github.event.pull_request.labels) }}
        run: echo "$GITHUB_CONTEXT_LABELS"
      - name: 'Add the PR to the merge queue via the GitHub CLI'
        if:
          ${{ contains(github.event.pull_request.labels.*.name,
          format('status{0} ready to merge ðŸŽ‰', ':')) ||
          contains(github.event.pull_request.labels.*.name, format('status{0}
          enable automerge ðŸŸ ', ':'))}}
        run: gh pr merge "$PR_URL"
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          PR_URL: ${{github.event.pull_request.html_url}}
          GH_DEBUG: api
